<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Duty Attendance with TA Form</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap">
  <style>
    :root {
      --bg: #f0f4ff; --card: #ffffff; --muted: #6b7280; --accent: #4f46e5; --success: #10b981; --danger: #ef4444; --yellow: #f59e0b; --ta: #0ea5e9; --rest: #3b82f6;
      --border-radius: 16px; --shadow: 0 10px 30px rgba(27, 61, 122, 0.08);
      --card-gradient: linear-gradient(145deg, #ffffff, #f8faff);
      --accent-gradient: linear-gradient(135deg, #4f46e5, #7c3aed);
      --success-gradient: linear-gradient(135deg, #10b981, #34d399);
      --danger-gradient: linear-gradient(135deg, #ef4444, #f87171);
      --yellow-gradient: linear-gradient(135deg, #f59e0b, #fbbf24);
      --rest-gradient: linear-gradient(135deg, #3b82f6, #60a5fa);
      --glass-bg: rgba(255, 255, 255, 0.7);
      --glass-border: rgba(255, 255, 255, 0.2);
    }

    [data-theme="dark"] {
      --bg: #0f172a; --card: #1e293b; --muted: #94a3b8; --accent: #6366f1; --success: #10b981; --danger: #f87171; --yellow: #fbbf24; --ta: #60f0ff; --rest: #60a5fa;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      --card-gradient: linear-gradient(145deg, #1e293b, #1a2332);
      --accent-gradient: linear-gradient(135deg, #6366f1, #8b5cf6);
      --glass-bg: rgba(30, 41, 59, 0.7);
      --glass-border: rgba(255, 255, 255, 0.1);
    }

    * {
      box-sizing: border-box;
      font-family: 'Inter', system-ui, sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text-color, #0f172a);
      transition: background 0.3s, color 0.3s;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Header Styles */
    header {
      background: var(--glass-bg);
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--glass-border);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-pay-rate {
      font-size: 14px;
      font-weight: 600;
      color: var(--success);
      padding: 4px 10px;
      background: rgba(16, 185, 129, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .header-user-info {
      font-size: 14px;
      color: var(--muted);
      margin-left: 10px;
    }

    /* Main Layout */
    .main-container {
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 60px);
      position: relative;
    }

    /* Calendar View - Default View */
    .calendar-view {
      width: 100%;
      height: 100%;
      padding: 18px;
      transition: transform 0.3s ease;
    }

    .calendar-view.active {
      transform: translateX(0);
    }

    .calendar-view.hidden {
      display: none;
    }

    /* Sidebar Menu - Initially Hidden */
    .sidebar-menu {
      width: 100%;
      height: 100%;
      padding: 18px;
      background: var(--bg);
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      overflow-y: auto;
      z-index: 50;
    }

    .sidebar-menu.active {
      transform: translateX(0);
    }

    .sidebar-menu.hidden {
      display: none;
    }

    /* Container */
    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 0;
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    select, input[type="month"] {
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border-color, #dbe7ff);
      background: var(--card);
      color: inherit;
      min-width: 150px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      transition: all 0.3s;
    }

    select:focus, input[type="month"]:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--accent);
    }

    button {
      padding: 10px 16px;
      border-radius: 10px;
      border: 0;
      background: var(--accent-gradient);
      color: #fff;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
      position: relative;
      overflow: hidden;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(79, 70, 229, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    /* Card Styles */
    .card {
      background: var(--card-gradient);
      padding: 18px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      transition: background 0.3s, box-shadow 0.3s;
      border: 1px solid var(--glass-border);
      position: relative;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--accent-gradient);
    }

    /* Calendar Grid */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    .day-header {
      text-align: center;
      padding: 10px 6px;
      color: var(--muted);
      font-weight: 700;
      font-size: 14px;
      background: var(--glass-bg);
      border-radius: 8px;
      backdrop-filter: blur(5px);
    }

    /* Calendar Cells */
    .cell {
      min-height: 80px;
      padding: 8px;
      border-radius: 12px;
      border: 1px solid transparent;
      position: relative;
      background: var(--card);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      perspective: 1000px;
      transform-style: preserve-3d;
    }

    .cell:hover {
      transform: translateY(-5px) rotateX(5deg);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .cell:active {
      transform: translateY(-2px) scale(0.98);
    }

    .cell.inactive {
      opacity: 0.35;
      pointer-events: none;
    }

    /* Status-based background colors */
    .cell.status-present {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
      border-left: 4px solid var(--success);
    }

    .cell.status-absent {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05));
      border-left: 4px solid var(--danger);
    }

    .cell.status-leave {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05));
      border-left: 4px solid var(--yellow);
    }

    .cell.status-rest {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));
      border-left: 4px solid var(--rest);
    }

    .date-num {
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 4px;
      position: relative;
      z-index: 2;
    }

    .status {
      position: absolute;
      right: 8px;
      top: 8px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      opacity: 0;
      transform: translateY(-5px);
      transition: all 0.3s ease;
    }

    .cell:hover .status {
      opacity: 1;
      transform: translateY(0);
    }

    .s-present {
      background: var(--success-gradient);
      color: white;
    }

    .s-absent {
      background: var(--danger-gradient);
      color: white;
    }

    .s-leave {
      background: var(--yellow-gradient);
      color: white;
    }

    .s-rest {
      background: var(--rest-gradient);
      color: white;
    }

    .ta-indicator {
      position: absolute;
      left: 8px;
      top: 8px;
      background: var(--yellow);
      color: white;
      font-size: 10px;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* Summary Styles */
    .small {
      font-size: 13px;
      color: var(--muted);
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-top: 1px solid var(--border-color, #f1f6ff);
      margin-top: 8px;
    }

    .summary-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .muted {
      color: var(--muted);
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .top-stats {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .stat {
      background: var(--card-gradient);
      padding: 12px 14px;
      border-radius: 12px;
      min-width: 120px;
      text-align: center;
      box-shadow: var(--shadow);
      border: 1px solid var(--glass-border);
      transition: transform 0.3s;
    }

    .stat:hover {
      transform: translateY(-3px);
    }

    .right {
      margin-left: auto;
    }

    .chip {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--border-color, rgba(0, 0, 0, 0.06));
      background: transparent;
      color: inherit;
      cursor: pointer;
      transition: all 0.3s;
    }

    .chip.active {
      background: var(--accent-gradient);
      color: white;
      border-color: var(--accent);
      box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
    }

    /* Modal Styles */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(11, 20, 50, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 200;
      backdrop-filter: blur(5px);
    }

    .modal {
      background: var(--card-gradient);
      width: 100%;
      max-width: 900px;
      border-radius: var(--border-radius);
      padding: 20px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
      border: 1px solid var(--glass-border);
    }

    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    label {
      font-size: 14px;
      color: var(--muted);
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
    }

    input[type="time"], select, input[type="text"], input[type="file"] {
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border-color, #e6eefc);
      background: var(--card);
      color: inherit;
      flex: 1;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      transition: all 0.3s;
    }

    input[type="time"]:focus, select:focus, input[type="text"]:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--accent);
    }

    textarea {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border-color, #e6eefc);
      background: var(--card);
      color: inherit;
      resize: vertical;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      transition: all 0.3s;
    }

    textarea:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--accent);
    }

    footer.note {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
    }

    .small-btn {
      background: var(--muted-bg, #f3f4f6);
      color: var(--text-color, #111);
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border-color, #e6eefc);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    /* Menu Button */
    .menu-button {
      background: var(--accent-gradient);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* TA Form Styles */
    .ta-form-header {
      border: 2px solid #000;
      padding: 12px;
      margin-bottom: 15px;
      background: white;
      color: black;
      font-size: 13px;
    }

    .ta-header-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 8px;
    }

    .ta-header-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .ta-header-item label {
      font-weight: bold;
      min-width: 100px;
      font-size: 12px;
      margin: 0;
    }

    .ta-header-item input {
      flex: 1;
      border: none;
      border-bottom: 1px solid #ccc;
      padding: 2px 4px;
      background: transparent;
      font-size: 12px;
    }

    .ta-header-title {
      text-align: center;
      margin-bottom: 8px;
      font-weight: bold;
    }

    /* TA Table */
    .ta-table-container table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      background: white;
      color: black;
      table-layout: fixed;
    }

    .ta-table-container th,
    .ta-table-container td {
      border: 1px solid #000;
      padding: 4px;
      text-align: left;
      background: white;
      color: black;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .ta-table-container th {
      background: #f0f0f0;
      font-weight: bold;
      font-size: 10px;
    }

    .ta-table-container input {
      width: 100%;
      border: none;
      padding: 3px;
      background: transparent;
      color: black;
      font-size: 10px;
      box-sizing: border-box;
    }

    .ta-table-container input:focus {
      background: #f0f8ff;
      outline: 2px solid #4f46e5;
    }

    .ta-table-container .date-column {
      background: #f8f9fa;
      font-weight: 600;
    }

    .ta-table-container .date-column input {
      font-weight: 600;
      color: #1e40af;
    }

    /* Login Styles */
    #loginOverlay{position:fixed;inset:0;background:#f3f4f6;z-index:99999;display:flex;align-items:center;justify-content:center;padding:10px}
    .loginCard{width:420px;max-width:100%;background:#fff;border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.1);padding:20px}
    .loginCard h3{margin:0 0 12px 0;text-align:center;font-size:20px;color:#111}
    .loginCard label{display:block;margin-top:8px;font-size:13px;color:#374151}
    .loginCard input,.loginCard button{width:100%;padding:10px;margin-top:4px;border-radius:8px;border:1px solid #d1d5db;font-size:14px}
    .loginCard button{background:#4f46e5;color:#fff;border:0;margin-top:12px;cursor:pointer}
    .loginCard button.ghost{background:#eef2ff;color:#111;border:1px solid #dbe7ff}
    .loginCard .note{font-size:13px;color:#555;margin-top:6px;text-align:center}
    #signupForm{display:none}
    .avatarPreview{width:60px;height:60px;border-radius:50%;object-fit:cover;background:#f3f4f6;margin-top:6px}

    /* Signup form scrollable container */
    .signup-form-container {
      max-height: 70vh;
      overflow-y: auto;
      padding-right: 5px;
    }

    /* Logout button */
    #logoutBtn{background:var(--danger-gradient);padding:8px 12px;font-size:12px;margin-left:8px;}

    /* Profile section in sidebar */
    .profile-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .profile-photo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--accent);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    .attendance-graph {
      width: 100%;
      background: var(--card);
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-top: 8px;
    }

    .graph-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      text-align: center;
      color: var(--muted);
    }

    .graph-bars {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      height: 120px;
      gap: 6px;
    }

    .graph-bar-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }

    .graph-bar {
      width: 100%;
      background: var(--bg);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
      height: 100px;
    }

    .graph-bar-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      border-radius: 4px;
      transition: height 0.5s ease;
    }

    .graph-bar-label {
      font-size: 10px;
      margin-top: 4px;
      text-align: center;
      font-weight: 600;
    }

    .graph-bar-count {
      font-size: 11px;
      margin-top: 2px;
      font-weight: 600;
    }

    /* Animation for modal */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal {
      animation: fadeIn 0.3s ease-out;
    }

    /* Print styles */
    @media print {
      body {
        background: white;
        color: black;
      }

      .card {
        box-shadow: none;
        border: 1px solid #ddd;
      }

      button, .actions, .controls select, .theme-controls, .menu-button {
        display: none !important;
      }

      header {
        position: static;
      }
    }

    /* Mobile Responsive */
    @media (max-width: 1024px) {
      .card {
        padding: 16px;
      }

      .container {
        padding: 12px;
      }

      .controls {
        gap: 8px;
      }

      .top-stats {
        width: 100%;
        justify-content: space-between;
        margin-top: 8px;
      }

      .stat {
        flex: 1;
        min-width: auto;
      }

      .calendar {
        grid-template-columns: repeat(7, 1fr);
        gap: 6px;
      }

      .cell {
        min-height: 70px;
        padding: 6px;
      }

      .date-num {
        font-size: 16px;
      }

      .status {
        font-size: 10px;
        padding: 3px 8px;
      }

      .ta-indicator {
        font-size: 8px;
        padding: 1px 4px;
      }

      .signup-form-container {
        max-height: 60vh;
      }
    }

    @media (max-width: 768px) {
      header {
        padding: 12px 16px;
      }

      header h1 {
        font-size: 16px;
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }

      .header-pay-rate {
        font-size: 12px;
        padding: 3px 8px;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      select, input[type="month"] {
        min-width: auto;
        width: 100%;
      }

      .calendar {
        grid-template-columns: repeat(7, 1fr);
      }

      .cell {
        min-height: 65px;
        padding: 5px;
      }

      .date-num {
        font-size: 15px;
      }

      .status {
        font-size: 9px;
        padding: 2px 6px;
        right: 6px;
        top: 6px;
      }

      .modal {
        padding: 16px;
        margin: 10px;
      }

      .form-row {
        flex-direction: column;
        gap: 12px;
      }

      .signup-form-container {
        max-height: 55vh;
      }
    }

    @media (max-width: 480px) {
      .calendar {
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
      }

      .cell {
        min-height: 60px;
        padding: 4px;
      }

      .date-num {
        font-size: 14px;
      }

      .day-header {
        font-size: 12px;
        padding: 6px 2px;
      }

      .actions {
        justify-content: center;
      }

      button {
        flex: 1;
        min-width: 120px;
        padding: 8px 12px;
      }

      .stat {
        padding: 8px 10px;
        min-width: 80px;
      }

      .ta-indicator {
        font-size: 7px;
        padding: 1px 3px;
        left: 4px;
        top: 4px;
      }

      .signup-form-container {
        max-height: 50vh;
      }

      .profile-photo {
        width: 70px;
        height: 70px;
      }

      .graph-bars {
        height: 100px;
      }

      .graph-bar {
        height: 80px;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body data-theme="light">
<!-- START: Integrated Secure Login -->
<div id="loginOverlay" role="dialog" aria-modal="true">
  <div class="loginCard">
    <h3 id="formTitle">Login</h3>
    <div id="loginForm">
      <label>Username or Email</label>
      <input id="lgUser" type="text" autocomplete="username" />
      <label>Password</label>
      <input id="lgPass" type="password" autocomplete="current-password" />
      
      <div style="display:flex;align-items:center;gap:8px;margin-top:8px;font-size:13px;">
        <input type="checkbox" id="rememberMe" checked />
        <label for="rememberMe" style="margin:0;">Always keep me logged in</label>
      </div>
      
      <button id="btnDoLogin">Login</button>
      <button id="btnShowSignup" class="ghost">Create new account</button>
      <div id="loginMsg" class="note"></div>
    </div>

    <div id="signupForm">
      <div class="signup-form-container">
        <label>Username (unique)</label><input id="suUser" type="text"/>
        <label>Email</label><input id="suEmail" type="email"/>
        <label>Password</label><input id="suPass" type="password"/>
        <label>Confirm Password</label><input id="suPass2" type="password"/>
        <label>Employee Name</label><input id="suEmpName" type="text"/>
        <label>Father's Name</label><input id="suFatherName" type="text"/>
        <label>Designation</label><input id="suDesignation" type="text"/>
        <label>Department</label><input id="suDepartment" type="text"/>
        <label>Head Quarter</label><input id="suHeadQuarter" type="text"/>
        <label>Employment No.</label><input id="suEmpNo" type="text"/>
        <label>Pay Rate (₹)</label><input id="suPayRate" type="text"/>
        <label>TA Rate (₹)</label><input id="suTaRate" type="text"/>
        <label>D.O.A (DD/MM/YYYY)</label><input id="suDOA" type="text"/>
        <label>Profile Photo</label><input id="suPhoto" type="file" accept="image/*"/><img id="avatarPrev" class="avatarPreview"/>
      </div>
      <button id="btnCreate">Sign Up</button>
      <button id="btnCancelSignup" class="ghost">Back to Login</button>
      <div id="suMsg" class="note"></div>
    </div>
  </div>
</div>

<script>
// Password hashing and user management functions
function toUtf8(s){return new TextEncoder().encode(s);}
function bufToB64(b){return btoa(String.fromCharCode(...new Uint8Array(b)));}
function b64ToBuf(b64){return Uint8Array.from(atob(b64),c=>c.charCodeAt(0));}
function genSalt(n=16){const a=new Uint8Array(n);crypto.getRandomValues(a);return a;}
async function pbkdf2(p,s,it=150000,len=32){const k=await crypto.subtle.importKey('raw',toUtf8(p),{name:'PBKDF2'},false,['deriveBits']);const pr={name:'PBKDF2',salt:s,iterations:it,hash:'SHA-256'};const d=await crypto.subtle.deriveBits(pr,k,len*8);return new Uint8Array(d);}
function ctEq(a,b){if(a.length!==b.length)return false;let r=0;for(let i=0;i<a.length;i++)r|=a.charCodeAt(i)^b.charCodeAt(i);return r===0;}
function loadUsers(){try{return JSON.parse(localStorage.getItem('att_users')||'{}');}catch(e){return{};}}
function saveUsers(u){localStorage.setItem('att_users',JSON.stringify(u));}

// Photo upload preview
const suPhoto=document.getElementById('suPhoto');const avatarPrev=document.getElementById('avatarPrev');
suPhoto.onchange=()=>{if(suPhoto.files&&suPhoto.files[0]){const r=new FileReader();r.onload=()=>avatarPrev.src=r.result;r.readAsDataURL(suPhoto.files[0]);}};

// Form toggle
document.getElementById('btnShowSignup').onclick=()=>{document.getElementById('loginForm').style.display='none';document.getElementById('signupForm').style.display='block';document.getElementById('formTitle').textContent='Sign Up';};
document.getElementById('btnCancelSignup').onclick=()=>{document.getElementById('signupForm').style.display='none';document.getElementById('loginForm').style.display='block';document.getElementById('formTitle').textContent='Login';};

// Create account
document.getElementById('btnCreate').onclick=async()=>{
 const u=(suUser.value||'').trim(),e=(suEmail.value||'').trim(),p=suPass.value,p2=suPass2.value;
 const msg=document.getElementById('suMsg');msg.textContent='';
 if(!u||!p){msg.textContent='Username and password required';return;}
 if(p.length<8){msg.textContent='Password too short';return;}
 if(p!==p2){msg.textContent='Passwords mismatch';return;}
 const users=loadUsers();if(users[u]){msg.textContent='Username already exists';return;}
 let photoData='';if(suPhoto.files&&suPhoto.files[0]){photoData=await new Promise(res=>{const r=new FileReader();r.onload=()=>res(r.result);r.readAsDataURL(suPhoto.files[0]);});}
 const profile={employeeName:suEmpName.value,fatherName:suFatherName.value,designation:suDesignation.value,department:suDepartment.value,headQuarter:suHeadQuarter.value,empNo:suEmpNo.value,payRate:suPayRate.value,taRate:suTaRate.value,doa:suDOA.value,photo:photoData};
 const salt=genSalt();const it=150000;const dk=await pbkdf2(p,salt,it,32);
 users[u]={username:u,email:e,salt:bufToB64(salt),derivedKey:bufToB64(dk),iterations:it,profile:profile,createdAt:new Date().toISOString()};
 saveUsers(users);msg.textContent='Account created. You can now login.';
};

// Login function
document.getElementById('btnDoLogin').onclick=async()=>{
 const name=(lgUser.value||'').trim(),pass=lgPass.value;const msg=document.getElementById('loginMsg');msg.textContent='';
 if(!name||!pass){msg.textContent='Enter both fields';return;}
 const users=loadUsers(),rec=users[name];if(!rec){msg.textContent='User not found';return;}
 const salt=b64ToBuf(rec.salt);const it=rec.iterations||150000;const dk=await pbkdf2(pass,salt,it,32);const b64=bufToB64(dk);
 if(!ctEq(b64,rec.derivedKey)){msg.textContent='Incorrect password';return;}
 
 // Set permanent session (no expiration)
 const sessionData = {username:rec.username, loggedInAt: Date.now()};
 localStorage.setItem('att_session', JSON.stringify(sessionData));
 
 localStorage.setItem('ta_profile',JSON.stringify(rec.profile||{}));
 localStorage.setItem('att_current_user',rec.username);
 document.getElementById('loginOverlay').style.display='none';
 updateHeaderForUser(rec.username);
 updateSidebarProfile(rec);
};

// Function to update header with user info and logout button
function updateHeaderForUser(username){
 const header = document.querySelector('header h1');
 
 // Remove existing user info if any
 const existingUserInfo = document.querySelector('.header-user-info');
 if(existingUserInfo) existingUserInfo.remove();
 
 const userInfo = document.createElement('span');
 userInfo.className = 'header-user-info';
 userInfo.textContent = `Welcome, ${username}`;
 header.appendChild(userInfo);
}

// Function to update sidebar with profile info
function updateSidebarProfile(user) {
  const profile = user.profile || {};
  const profileSection = document.getElementById('profileSection');
  
  // Update profile photo
  const profilePhoto = document.getElementById('sidebarProfilePhoto');
  if (profile.photo) {
    profilePhoto.src = profile.photo;
    profilePhoto.style.display = 'block';
  } else {
    profilePhoto.style.display = 'none';
  }
  
  // Update profile name
  const profileName = document.getElementById('sidebarProfileName');
  if (profile.employeeName) {
    profileName.textContent = profile.employeeName;
  } else {
    profileName.textContent = user.username;
  }
  
  // Update profile info
  const profileInfo = document.getElementById('sidebarProfileInfo');
  if (profileInfo) {
    profileInfo.innerHTML = `
      <div class="small">${profile.designation || ''}</div>
      <div class="small">${profile.department || ''}</div>
    `;
  }
}

// Logout function
function logoutUser(){
 if(confirm('Are you sure you want to logout?')){
   // Clear session data
   localStorage.removeItem('att_session');
   localStorage.removeItem('att_current_user');
   // Note: We don't remove ta_profile as it might be needed
   
   // Show login overlay
   document.getElementById('loginOverlay').style.display = 'flex';
   
   // Remove user info from header
   const userInfo = document.querySelector('.header-user-info');
   if(userInfo) userInfo.remove();
   
   // Clear login form
   document.getElementById('lgUser').value = '';
   document.getElementById('lgPass').value = '';
   document.getElementById('rememberMe').checked = true;
 }
}

// Check for existing session on page load - ALWAYS remember user
(function(){
 try{
   const session = JSON.parse(localStorage.getItem('att_session') || 'null');
   
   if(session && session.username){
     document.getElementById('loginOverlay').style.display='none';
     const users = loadUsers();
     const user = users[session.username];
     if(user){
       updateHeaderForUser(session.username);
       updateSidebarProfile(user);
       // Make sure profile is loaded
       if(!localStorage.getItem('ta_profile')){
         localStorage.setItem('ta_profile', JSON.stringify(user.profile || {}));
       }
     }
   }
 }catch(e){
   console.log('Error checking session:', e);
 }
})();
</script>
<!-- END: Integrated Secure Login -->

  <header>
    <h1>Smart Duty Attendance with TA Form <span id="headerPayRate" class="header-pay-rate"></span></h1>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="menuToggle" class="menu-button">☰ Menu</button>
      <button id="themeToggle" class="small-btn">Dark</button>
      <div class="small muted">Local • Auto-save</div>
    </div>
  </header>

  <div class="main-container">
    <!-- Calendar View (Default) -->
    <div class="calendar-view active" id="calendarView">
      <div class="container">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
            <div><strong id="monthLabel"></strong><div class="small" id="monthRange"></div></div>
            <div class="small">Click a date to edit • Long-press to quick toggle Present</div>
          </div>

          <div class="calendar" id="calendar">
            <!-- Calendar will be generated here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar Menu (Initially Hidden) -->
    <div class="sidebar-menu" id="sidebarMenu">
      <div class="container">
        <!-- Profile Section with Photo and Graph -->
        <div class="card">
          <div class="profile-section">
            <img id="sidebarProfilePhoto" class="profile-photo" src="" alt="Profile Photo" style="display: none;">
            <div id="sidebarProfileName" style="font-weight: 600; font-size: 16px;"></div>
            <div id="sidebarProfileInfo" class="small"></div>
            
            <!-- Attendance Graph -->
            <div class="attendance-graph">
              <div class="graph-title">This Month's Attendance</div>
              <div class="graph-bars">
                <div class="graph-bar-container">
                  <div class="graph-bar">
                    <div class="graph-bar-fill" id="graphPresent" style="background: var(--success-gradient); height: 0%;"></div>
                  </div>
                  <div class="graph-bar-label">Present</div>
                  <div class="graph-bar-count" id="graphPresentCount">0</div>
                </div>
                <div class="graph-bar-container">
                  <div class="graph-bar">
                    <div class="graph-bar-fill" id="graphAbsent" style="background: var(--danger-gradient); height: 0%;"></div>
                  </div>
                  <div class="graph-bar-label">Absent</div>
                  <div class="graph-bar-count" id="graphAbsentCount">0</div>
                </div>
                <div class="graph-bar-container">
                  <div class="graph-bar">
                    <div class="graph-bar-fill" id="graphLeave" style="background: var(--yellow-gradient); height: 0%;"></div>
                  </div>
                  <div class="graph-bar-label">Leave</div>
                  <div class="graph-bar-count" id="graphLeaveCount">0</div>
                </div>
                <div class="graph-bar-container">
                  <div class="graph-bar">
                    <div class="graph-bar-fill" id="graphRest" style="background: var(--rest-gradient); height: 0%;"></div>
                  </div>
                  <div class="graph-bar-label">Rest</div>
                  <div class="graph-bar-count" id="graphRestCount">0</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Month Summary</h3>
          <div class="summary-row">
            <div class="summary-item"><div class="muted">Present</div><div id="sumPresent">0</div></div>
            <div class="summary-item"><div class="muted">Absent</div><div id="sumAbsent">0</div></div>
            <div class="summary-item"><div class="muted">Leave</div><div id="sumLeave">0</div></div>
            <div class="summary-item"><div class="muted">Rest</div><div id="sumRest">0</div></div>
          </div>
          <div class="summary-row">
            <div class="summary-item"><div class="muted">Duty Days</div><div id="sumDutyDays">0</div></div>
            <div class="summary-item"><div class="muted">Total Hours</div><div id="sumHours">0</div></div>
            <div class="summary-item"><div class="muted">TA Entries</div><div id="sumTa">0</div></div>
          </div>
        </div>

        <div class="card">
          <h3>Controls</h3>
          <div class="controls">
            <input id="monthPicker" type="month" />
            <select id="shiftPreset">
              <option value="any">Shift Preset</option>
              <option value="morning">Morning (09:00 - 17:00)</option>
              <option value="evening">Evening (14:00 - 22:00)</option>
              <option value="night">Night (22:00 - 06:00)</option>
            </select>

            <div class="top-stats">
              <div class="stat"><div class="muted">Days</div><div id="statDays">0</div></div>
              <div class="stat"><div class="muted">Total Hrs</div><div id="statHours">0h</div></div>
              <div class="stat"><div class="muted">Present</div><div id="statPresent">0</div></div>
              <div class="stat"><div class="muted">Leave</div><div id="statLeave">0</div></div>
              <div class="stat"><div class="muted">Rest</div><div id="statRest">0</div></div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Actions</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="exportCsv">Export CSV</button>
            <button id="exportPdf" class="small-btn">Export PDF</button>
            <button id="printReport" class="small-btn">Print</button>
          </div>

          <!-- Profile Setup Button -->
          <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="setupProfile" style="background:var(--success-gradient)">Setup Profile</button>
          </div>

          <!-- TA Form Button -->
          <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="openTaForm" style="background:var(--yellow-gradient)">Open TA Form (Northern Railway)</button>
          </div>
          
          <!-- Logout Button -->
          <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="sidebarLogoutBtn" style="background:var(--danger-gradient)">Logout</button>
          </div>
        </div>

        <div class="card">
          <h3>Theme Settings</h3>
          <div style="display:flex;gap:6px;margin-top:6px">
            <button id="themeLight" class="chip active">Light</button>
            <button id="themeDark" class="chip">Dark</button>
          </div>
        </div>

        <div class="card">
          <footer class="note">Tip: First setup your profile, then use TA Form for Northern Railway travelling allowance.</footer>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Entry Modal -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalTitle">Details</h3>
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
        <div class="small">Date: <strong id="modalDate"></strong></div>
        <div style="margin-left:auto"><span class="small muted" id="modalDayName"></span></div>
      </div>

      <div>
        <label>Status</label>
        <select id="statusSelect">
          <option value="">-- choose --</option>
          <option value="present">Present</option>
          <option value="absent">Absent</option>
          <option value="leave">Leave</option>
          <option value="rest">Rest</option>
        </select>
      </div>

      <!-- Show these fields only when status is present -->
      <div id="presentFields" style="display:none;">
        <div class="form-row">
          <div style="flex:1">
            <label>Duty ON (time)</label>
            <input id="timeOn" type="time" />
          </div>
          <div style="flex:1">
            <label>Duty OFF (time)</label>
            <input id="timeOff" type="time" />
          </div>
        </div>

        <div class="form-row">
          <div style="flex:1">
            <label>Shift</label>
            <select id="shiftSelect">
              <option value="">-- select --</option>
              <option value="morning">Morning</option>
              <option value="evening">Evening</option>
              <option value="night">Night</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Duty Duration</label>
            <input id="duration" type="text" readonly placeholder="auto-calculated" />
          </div>
        </div>

        <!-- TA Section - Show only when TA is applicable -->
        <div style="margin-top:8px">
          <label>
            <input type="checkbox" id="taApplicable" /> Travel Allowance (TA) Applicable
          </label>
          
          <div id="taFields" style="display:none; margin-top:8px">
            <!-- Travel Mode Selection -->
            <div class="form-row">
              <div style="flex:1">
                <label>Travel Mode</label>
                <select id="taTravelMode">
                  <option value="train">By Train</option>
                  <option value="road">By Road</option>
                </select>
              </div>
            </div>

            <!-- Separate Train Numbers for Onward and Return -->
            <div id="trainNoContainer" style="display:none;">
              <div class="form-row">
                <div style="flex:1">
                  <label>Onward Train No.</label>
                  <input id="taOnwardTrainNo" type="text" placeholder="Onward train number" />
                </div>
                <div style="flex:1">
                  <label>Return Train No.</label>
                  <input id="taReturnTrainNo" type="text" placeholder="Return train number" />
                </div>
              </div>
            </div>

            <div style="display:flex;gap:8px;margin-top:6px">
              <input id="taFrom" type="text" placeholder="From (place)" />
              <input id="taTo" type="text" placeholder="To (place)" />
            </div>
            <div class="form-row">
              <div style="flex:1">
                <label class="small">Departure Time (From HQ)</label>
                <input id="taDepartureTime" type="time" />
              </div>
              <div style="flex:1">
                <label class="small">Arrival Time (At Destination)</label>
                <input id="taArrivalTime" type="time" />
              </div>
            </div>
            <div class="form-row">
              <div style="flex:1">
                <label class="small">Return Departure Time</label>
                <input id="taReturnDepartureTime" type="time" />
              </div>
              <div style="flex:1">
                <label class="small">Return Arrival Time (At HQ)</label>
                <input id="taReturnArrivalTime" type="time" />
              </div>
            </div>
            <div style="margin-top:8px">
              <label>Object of Journey</label>
              <input id="taObject" type="text" placeholder="Purpose of travel" />
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top:8px">
        <label>Notes</label>
        <textarea id="notes" rows="3"></textarea>
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="deleteEntry" style="background:var(--danger-gradient)">Delete</button>
        <button id="closeModal" style="background:#94a3b8">Cancel</button>
        <button id="saveEntry">Save</button>
      </div>
    </div>
  </div>

  <!-- Profile Setup Modal -->
  <div id="profileModalBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" style="max-width: 600px;">
      <h3>Setup Your Profile</h3>
      
      <div style="margin-top:15px;">
        <label>Employee Name</label>
        <input type="text" id="profileEmployeeName" placeholder="Enter your full name" style="width: 100%;" />
      </div>

      <div style="margin-top:12px;">
        <label>Father's Name</label>
        <input type="text" id="profileFatherName" placeholder="Enter father's name" style="width: 100%;" />
      </div>

      <div style="margin-top:12px;">
        <label>Designation</label>
        <input type="text" id="profileDesignation" placeholder="Enter your designation" style="width: 100%;" />
      </div>

      <div style="margin-top:12px;">
        <label>Department</label>
        <input type="text" id="profileDepartment" placeholder="Enter department" style="width: 100%;" />
      </div>

      <div style="margin-top:12px;">
        <label>Head Quarter</label>
        <input type="text" id="profileHeadQuarter" placeholder="Enter head quarter" style="width: 100%;" />
      </div>

      <div class="form-row">
        <div style="flex:1">
          <label>Employment No</label>
          <input type="text" id="profileEmpNo" placeholder="Enter employment number" style="width: 100%;" />
        </div>
        <div style="flex:1">
          <label>Pay Rate (Rs.)</label>
          <input type="text" id="profilePayRate" placeholder="13789" style="width: 100%;" />
        </div>
      </div>

      <div style="margin-top:12px;">
        <label>Date of Appointment (D.O.A)</label>
        <input type="text" id="profileDOA" placeholder="DD/MM/YYYY" style="width: 100%;" />
      </div>

      <!-- TA Rate फील्ड -->
      <div style="margin-top:12px;">
        <label>TA Rate (Rs.)</label>
        <input type="text" id="profileTaRate" placeholder="635" style="width: 100%;" />
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px;">
        <button id="closeProfileModal" style="background:#94a3b8">Cancel</button>
        <button id="saveProfile" style="background:var(--success-gradient)">Save Profile</button>
      </div>
    </div>
  </div>

  <!-- TA Form Modal -->
  <div id="taModalBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" style="max-width: 1100px;">
      <h3 style="margin-bottom: 12px; font-size: 16px;">Northern Railway - Travelling Allowance Form</h3>
      
      <!-- Compact TA Form Header -->
      <div class="ta-form-header">
        <div class="ta-header-title">
          <div style="font-size: 14px; font-weight: bold;">NORTHERN RAILWAY</div>
          <div style="font-size: 12px;">Travelling Allowance Journal</div>
        </div>

        <div class="ta-header-grid">
          <div class="ta-header-item">
            <label>Department:</label>
            <input type="text" id="taDepartment" placeholder="Head Quarters">
          </div>
          <div class="ta-header-item">
            <label>Head Quarter:</label>
            <input type="text" id="taHeadQuarter" placeholder="Head Quarter">
          </div>
          <div class="ta-header-item">
            <label>Employee Name:</label>
            <input type="text" id="taEmployeeName" placeholder="Full Name">
          </div>
          <div class="ta-header-item">
            <label>Father's Name:</label>
            <input type="text" id="taFatherName" placeholder="Father's Name">
          </div>
          <div class="ta-header-item">
            <label>Designation:</label>
            <input type="text" id="taDesignation" placeholder="T.M.TX">
          </div>
          <div class="ta-header-item">
            <label>Month:</label>
            <input type="text" id="taMonth" placeholder="Month Year">
          </div>
          <div class="ta-header-item">
            <label>Pay Rate (Rs.):</label>
            <input type="text" id="taPayRate" placeholder="13,789">
          </div>
          <div class="ta-header-item">
            <label>Emp No:</label>
            <input type="text" id="taEmpNo" placeholder="">
          </div>
          <div class="ta-header-item">
            <label>D.O.A:</label>
            <input type="text" id="taDOA" placeholder="DD/MM/YYYY">
          </div>
        </div>
      </div>

      <!-- TA Table with Improved Date Columns (P. column removed) -->
      <div class="ta-table-container">
        <table id="taTable">
          <thead>
            <tr>
              <th style="width: 10%;">Date (From HQ to Dist)</th>
              <th style="width: 10%;">Date (Dist to HQ)</th>
              <th style="width: 7%;">Onward Train No.</th>
              <th style="width: 7%;">Return Train No.</th>
              <th style="width: 6%;">Dept Time (HQ)</th>
              <th style="width: 6%;">Arr Time (Dest)</th>
              <th style="width: 6%;">From</th>
              <th style="width: 6%;">To</th>
              <th style="width: 6%;">Return Dept</th>
              <th style="width: 6%;">Return Arr (HQ)</th>
              <th style="width: 18%;">Object of journey</th>
              <th style="width: 5%;">Hours</th>
              <th style="width: 5%;">Rate</th>
              <th style="width: 5%;">%</th>
              <th style="width: 7%;">Amount Rs.</th>
            </tr>
          </thead>
          <tbody id="taTableBody">
            <!-- Rows will be added dynamically -->
          </tbody>
        </table>
      </div>

      <!-- Add Row Button -->
      <div style="margin-top: 10px;">
        <button id="addTaRow" type="button" class="small-btn">Add Row</button>
      </div>

      <!-- Notes Section -->
      <div style="margin-top: 12px; padding: 8px; border: 1px solid #ccc; background: #f9f9f9;">
        <div style="font-weight: bold; margin-bottom: 4px; font-size: 12px;">NOTE BOOK</div>
        <textarea id="taNotes" rows="2" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 11px;" placeholder="Additional notes..."></textarea>
      </div>

      <!-- Percentage Summary Section -->
      <div style="margin-top: 12px; border: 1px solid #ccc; padding: 8px; background: #f9f9f9;">
        <div style="font-weight: bold; margin-bottom: 6px; font-size: 12px;">Percentage Summary</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; text-align: center;">
          <div>
            <div style="font-size: 10px; color: #666;">30% Count</div>
            <div id="count30" style="font-weight: bold; font-size: 14px;">0</div>
          </div>
          <div>
            <div style="font-size: 10px; color: #666;">70% Count</div>
            <div id="count70" style="font-weight: bold; font-size: 14px;">0</div>
          </div>
          <div>
            <div style="font-size: 10px; color: #666;">100% Count</div>
            <div id="count100" style="font-weight: bold; font-size: 14px;">0</div>
          </div>
          <div>
            <div style="font-size: 10px; color: #666;">Total Amount</div>
            <div id="totalAmount" style="font-weight: bold; font-size: 14px; color: #4f46e5;">₹0</div>
          </div>
        </div>
      </div>

      <!-- Footer Section -->
      <div style="margin-top: 12px; border: 1px solid #ccc; padding: 10px; background: #f9f9f9;">
        <div style="font-weight: bold; margin-bottom: 6px; font-size: 12px;">Approval & Signature</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
          <div>
            <label style="font-size: 10px; color: #666;">Controlling Officer</label>
            <input type="text" id="taControllingOfficer" placeholder="Name of Controlling Officer" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 11px;">
          </div>
          <div>
            <label style="font-size: 10px; color: #666;">Head Office</label>
            <input type="text" id="taHeadOffice" placeholder="Head Office" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 11px;">
          </div>
          <div>
            <label style="font-size: 10px; color: #666;">Signature</label>
            <input type="text" id="taSignature" placeholder="Signature" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 11px;">
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px;">
        <button id="closeTaModal" style="background: #94a3b8; padding: 8px 12px;">Cancel</button>
        <button id="printTaForm" style="background: var(--accent-gradient); padding: 8px 12px;">Print Form</button>
        <button id="saveTaForm" style="background: var(--success-gradient); padding: 8px 12px;">Save & Download</button>
      </div>
    </div>
  </div>

  <script>
    // App logic
    const DAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const monthPicker = document.getElementById('monthPicker');
    const calendarEl = document.getElementById('calendar');
    const monthLabel = document.getElementById('monthLabel');
    const monthRange = document.getElementById('monthRange');
    const sumPresent = document.getElementById('sumPresent');
    const sumAbsent = document.getElementById('sumAbsent');
    const sumLeave = document.getElementById('sumLeave');
    const sumRest = document.getElementById('sumRest');
    const sumDutyDays = document.getElementById('sumDutyDays');
    const sumHours = document.getElementById('sumHours');
    const sumTa = document.getElementById('sumTa');

    const statDays = document.getElementById('statDays');
    const statHours = document.getElementById('statHours');
    const statPresent = document.getElementById('statPresent');
    const statLeave = document.getElementById('statLeave');
    const statRest = document.getElementById('statRest');

    const modal = document.getElementById('modalBackdrop');
    const statusSelect = document.getElementById('statusSelect');
    const timeOn = document.getElementById('timeOn');
    const timeOff = document.getElementById('timeOff');
    const shiftSelect = document.getElementById('shiftSelect');
    const durationInput = document.getElementById('duration');
    const taApplicable = document.getElementById('taApplicable');
    const taFields = document.getElementById('taFields');
    const taFrom = document.getElementById('taFrom');
    const taTo = document.getElementById('taTo');
    const taDepartureTime = document.getElementById('taDepartureTime');
    const taArrivalTime = document.getElementById('taArrivalTime');
    const taReturnDepartureTime = document.getElementById('taReturnDepartureTime');
    const taReturnArrivalTime = document.getElementById('taReturnArrivalTime');
    const taObject = document.getElementById('taObject');
    const notes = document.getElementById('notes');
    const presentFields = document.getElementById('presentFields');

    // Travel Mode Elements
    const taTravelMode = document.getElementById('taTravelMode');
    const taOnwardTrainNo = document.getElementById('taOnwardTrainNo');
    const taReturnTrainNo = document.getElementById('taReturnTrainNo');
    const trainNoContainer = document.getElementById('trainNoContainer');

    const saveBtn = document.getElementById('saveEntry');
    const closeBtn = document.getElementById('closeModal');
    const deleteBtn = document.getElementById('deleteEntry');

    const exportCsvBtn = document.getElementById('exportCsv');
    const exportPdfBtn = document.getElementById('exportPdf');
    const printBtn = document.getElementById('printReport');

    const themeToggle = document.getElementById('themeToggle');
    const themeLight = document.getElementById('themeLight');
    const themeDark = document.getElementById('themeDark');
    const shiftPreset = document.getElementById('shiftPreset');

    // Menu Toggle
    const menuToggle = document.getElementById('menuToggle');
    const calendarView = document.getElementById('calendarView');
    const sidebarMenu = document.getElementById('sidebarMenu');

    // Profile Setup Elements
    const profileModal = document.getElementById('profileModalBackdrop');
    const setupProfileBtn = document.getElementById('setupProfile');
    const closeProfileModalBtn = document.getElementById('closeProfileModal');
    const saveProfileBtn = document.getElementById('saveProfile');

    // TA Form Elements
    const taModal = document.getElementById('taModalBackdrop');
    const openTaFormBtn = document.getElementById('openTaForm');
    const closeTaModalBtn = document.getElementById('closeTaModal');
    const addTaRowBtn = document.getElementById('addTaRow');
    const printTaFormBtn = document.getElementById('printTaForm');
    const saveTaFormBtn = document.getElementById('saveTaForm');
    const taTableBody = document.getElementById('taTableBody');

    // Logout button in sidebar
    const sidebarLogoutBtn = document.getElementById('sidebarLogoutBtn');

    let state = { year: null, month: null, data: {} };
    let activeDateKey = null;

    /* Menu Toggle Functionality */
    menuToggle.addEventListener('click', toggleMenu);

    function toggleMenu() {
      if (calendarView.classList.contains('active')) {
        // Show menu, hide calendar
        calendarView.classList.remove('active');
        calendarView.classList.add('hidden');
        sidebarMenu.classList.remove('hidden');
        sidebarMenu.classList.add('active');
        menuToggle.textContent = '← Back';
        
        // Update the attendance graph when opening the menu
        updateAttendanceGraph();
      } else {
        // Show calendar, hide menu
        calendarView.classList.remove('hidden');
        calendarView.classList.add('active');
        sidebarMenu.classList.remove('active');
        sidebarMenu.classList.add('hidden');
        menuToggle.textContent = '☰ Menu';
      }
    }

    // Sidebar logout button
    sidebarLogoutBtn.addEventListener('click', logoutUser);

    /* Utilities */
    function formatYMD(y, m, d) {
      return `${y.toString().padStart(4, '0')}-${(m).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
    }

    function storageKey() {
      return `att_${state.year}-${String(state.month).padStart(2, '0')}`;
    }

    /* Load/Save */
    function loadMonthData() {
      const raw = localStorage.getItem(storageKey());
      state.data = raw ? JSON.parse(raw) : {};
      updateSummary();
      updateAttendanceGraph();
    }

    function saveMonthData() {
      localStorage.setItem(storageKey(), JSON.stringify(state.data));
      updateSummary();
      updateAttendanceGraph();
    }

    /* Update attendance graph */
    function updateAttendanceGraph() {
      let p = 0, a = 0, l = 0, r = 0;
      for (const k in state.data) {
        const e = state.data[k];
        if (!e) continue;
        if (e.status === 'present') p++;
        if (e.status === 'absent') a++;
        if (e.status === 'leave') l++;
        if (e.status === 'rest') r++;
      }
      
      const daysInMonth = new Date(state.year, state.month, 0).getDate();
      const maxDays = daysInMonth;
      
      // Calculate percentages for graph
      const pPercent = Math.min(100, (p / maxDays) * 100);
      const aPercent = Math.min(100, (a / maxDays) * 100);
      const lPercent = Math.min(100, (l / maxDays) * 100);
      const rPercent = Math.min(100, (r / maxDays) * 100);
      
      // Update graph bars
      document.getElementById('graphPresent').style.height = `${pPercent}%`;
      document.getElementById('graphAbsent').style.height = `${aPercent}%`;
      document.getElementById('graphLeave').style.height = `${lPercent}%`;
      document.getElementById('graphRest').style.height = `${rPercent}%`;
      
      // Update counts
      document.getElementById('graphPresentCount').textContent = p;
      document.getElementById('graphAbsentCount').textContent = a;
      document.getElementById('graphLeaveCount').textContent = l;
      document.getElementById('graphRestCount').textContent = r;
    }

    /* Render calendar */
    function renderCalendar() {
      calendarEl.innerHTML = '';
      const first = new Date(state.year, state.month - 1, 1);
      const daysInMonth = new Date(state.year, state.month, 0).getDate();
      monthLabel.textContent = first.toLocaleString(undefined, { month: 'long', year: 'numeric' });
      monthRange.textContent = `${state.year}-${String(state.month).padStart(2, '0')}`;

      // Update header with pay rate
      updateHeaderPayRate();

      for (let i = 0; i < 7; i++) {
        const hd = document.createElement('div');
        hd.className = 'day-header';
        hd.textContent = DAYS[i];
        calendarEl.appendChild(hd);
      }

      for (let blank = 0; blank < first.getDay(); blank++) {
        const c = document.createElement('div');
        c.className = 'cell inactive';
        calendarEl.appendChild(c);
      }

      for (let d = 1; d <= daysInMonth; d++) {
        const ymd = formatYMD(state.year, state.month, d);
        const cell = document.createElement('div');
        cell.className = 'cell';
        const dateNum = document.createElement('div');
        dateNum.className = 'date-num';
        dateNum.textContent = d;
        cell.appendChild(dateNum);

        const entry = state.data[ymd];
        if (entry) {
          // Add status class to cell for background color
          if (entry.status) {
            cell.classList.add(`status-${entry.status}`);
          }

          // Add TA indicator if TA data exists
          if (entry.taFrom || entry.taTo) {
            const taIndicator = document.createElement('div');
            taIndicator.className = 'ta-indicator';
            taIndicator.textContent = 'TA';
            cell.appendChild(taIndicator);
          }

          const st = document.createElement('div');
          // Update status classes to include rest
          if (entry.status === 'present') {
            st.className = 'status s-present';
          } else if (entry.status === 'absent') {
            st.className = 'status s-absent';
          } else if (entry.status === 'leave') {
            st.className = 'status s-leave';
          } else if (entry.status === 'rest') {
            st.className = 'status s-rest';
          }
          st.textContent = entry.status ? entry.status.toUpperCase() : '';
          cell.appendChild(st);
        }

        // click to open modal
        cell.addEventListener('click', () => openModal(ymd));
        // long press quick toggle present
        let pressTimer;
        cell.addEventListener('pointerdown', (e) => { pressTimer = setTimeout(() => { quickTogglePresent(ymd); }, 600); });
        cell.addEventListener('pointerup', () => clearTimeout(pressTimer));
        cell.addEventListener('pointerleave', () => clearTimeout(pressTimer));

        calendarEl.appendChild(cell);
      }
    }

    /* Modal */
    function openModal(ymd) {
      activeDateKey = ymd;
      const [y, m, d] = ymd.split('-');
      document.getElementById('modalDate').textContent = `${d}-${m}-${y}`;
      document.getElementById('modalDayName').textContent = new Date(Number(y), Number(m) - 1, Number(d)).toLocaleString(undefined, { weekday: 'long' });
      document.getElementById('modalTitle').textContent = `Details — ${ymd}`;

      const e = state.data[ymd] || {};
      statusSelect.value = e.status || '';
      
      // Show/hide present fields based on status
      if (e.status === 'present') {
        presentFields.style.display = 'block';
        timeOn.value = e.timeOn || '';
        timeOff.value = e.timeOff || '';
        shiftSelect.value = e.shift || '';
        durationInput.value = e.duration || '';
        
        // TA fields
        taApplicable.checked = !!(e.taFrom || e.taTo);
        taFields.style.display = taApplicable.checked ? 'block' : 'none';
        
        // Travel mode and train numbers
        taTravelMode.value = e.taTravelMode || 'train';
        if (taTravelMode.value === 'train') {
          trainNoContainer.style.display = 'block';
          taOnwardTrainNo.value = e.taOnwardTrainNo || '';
          taReturnTrainNo.value = e.taReturnTrainNo || '';
        } else {
          trainNoContainer.style.display = 'none';
          // Auto-fill "By Road" when travel mode is road
          taOnwardTrainNo.value = 'By Road';
          taReturnTrainNo.value = 'By Road';
        }
        
        taFrom.value = e.taFrom || '';
        taTo.value = e.taTo || '';
        taDepartureTime.value = e.taDepartureTime || '';
        taArrivalTime.value = e.taArrivalTime || '';
        taReturnDepartureTime.value = e.taReturnDepartureTime || '';
        taReturnArrivalTime.value = e.taReturnArrivalTime || '';
        taObject.value = e.taObject || '';
      } else {
        presentFields.style.display = 'none';
      }
      
      notes.value = e.notes || '';

      modal.style.display = 'flex';
    }

    function closeModal() {
      modal.style.display = 'none';
      activeDateKey = null;
    }

    function quickTogglePresent(ymd) {
      const cur = state.data[ymd] || {};
      if (cur.status === 'present') {
        delete state.data[ymd];
      } else {
        state.data[ymd] = { ...(cur || {}), status: 'present' };
      }
      saveMonthData();
      renderCalendar();
    }

    /* Duration calc */
    function calcDuration(tOn, tOff) {
      if (!tOn || !tOff) return '';
      const [h1, m1] = tOn.split(':').map(Number);
      const [h2, m2] = tOff.split(':').map(Number);
      let start = h1 * 60 + m1;
      let end = h2 * 60 + m2;
      if (end < start) end += 24 * 60;
      const mins = end - start;
      if (mins < 0) return '';
      const hrs = Math.floor(mins / 60);
      const rem = mins % 60;
      return `${hrs}h ${rem}m`;
    }

    // Auto-fill TA times when duty times change
    timeOn.addEventListener('change', () => {
      durationInput.value = calcDuration(timeOn.value, timeOff.value);
      if (!taDepartureTime.value) {
        taDepartureTime.value = timeOn.value;
      }
    });

    timeOff.addEventListener('change', () => {
      durationInput.value = calcDuration(timeOn.value, timeOff.value);
      if (!taReturnArrivalTime.value) {
        taReturnArrivalTime.value = timeOff.value;
      }
    });

    // Show/hide TA fields based on checkbox
    taApplicable.addEventListener('change', () => {
      taFields.style.display = taApplicable.checked ? 'block' : 'none';
    });

    // Show/hide present fields based on status
    statusSelect.addEventListener('change', () => {
      if (statusSelect.value === 'present') {
        presentFields.style.display = 'block';
      } else {
        presentFields.style.display = 'none';
        taApplicable.checked = false;
        taFields.style.display = 'none';
      }
    });

    // Show/hide train numbers based on travel mode AND auto-fill "By Road" when road is selected
    taTravelMode.addEventListener('change', () => {
      if (taTravelMode.value === 'train') {
        trainNoContainer.style.display = 'block';
        // Clear any previous "By Road" values
        if (taOnwardTrainNo.value === 'By Road') taOnwardTrainNo.value = '';
        if (taReturnTrainNo.value === 'By Road') taReturnTrainNo.value = '';
      } else {
        trainNoContainer.style.display = 'none';
        // Auto-fill "By Road" in both train number fields
        taOnwardTrainNo.value = 'By Road';
        taReturnTrainNo.value = 'By Road';
      }
    });

    saveBtn.addEventListener('click', () => {
      if (!activeDateKey) return;
      const payload = {
        status: statusSelect.value,
        notes: notes.value.trim()
      };

      // Only include present fields if status is present
      if (statusSelect.value === 'present') {
        payload.timeOn = timeOn.value;
        payload.timeOff = timeOff.value;
        payload.shift = shiftSelect.value;
        payload.duration = durationInput.value || calcDuration(timeOn.value, timeOff.value);
        
        // Only include TA fields if TA is applicable
        if (taApplicable.checked) {
          // Save travel mode and train numbers
          payload.taTravelMode = taTravelMode.value;
          if (taTravelMode.value === 'train') {
            payload.taOnwardTrainNo = taOnwardTrainNo.value.trim();
            payload.taReturnTrainNo = taReturnTrainNo.value.trim();
          } else {
            // For road travel, store "By Road" explicitly
            payload.taOnwardTrainNo = 'By Road';
            payload.taReturnTrainNo = 'By Road';
          }
          
          payload.taFrom = taFrom.value.trim();
          payload.taTo = taTo.value.trim();
          payload.taDepartureTime = taDepartureTime.value;
          payload.taArrivalTime = taArrivalTime.value;
          payload.taReturnDepartureTime = taReturnDepartureTime.value;
          payload.taReturnArrivalTime = taReturnArrivalTime.value;
          payload.taObject = taObject.value.trim();
        }
      }

      const hasAny = Object.values(payload).some(v => v && v !== '');
      if (!hasAny) {
        delete state.data[activeDateKey];
      } else {
        state.data[activeDateKey] = payload;
      }
      saveMonthData();
      renderCalendar();
      closeModal();
    });

    closeBtn.addEventListener('click', () => closeModal());
    deleteBtn.addEventListener('click', () => {
      if (!activeDateKey) return;
      if (confirm('Delete entry for ' + activeDateKey + ' ?')) {
        delete state.data[activeDateKey];
        saveMonthData();
        renderCalendar();
        closeModal();
      }
    });

    /* Exports */
    exportCsvBtn.addEventListener('click', () => {
      const rows = [['date', 'status', 'timeOn', 'timeOff', 'duration', 'shift', 'taTravelMode', 'taOnwardTrainNo', 'taReturnTrainNo', 'taFrom', 'taTo', 'taDepartureTime', 'taArrivalTime', 'taReturnDepartureTime', 'taReturnArrivalTime', 'taObject', 'notes']];
      const key = storageKey();
      const raw = JSON.parse(localStorage.getItem(key) || '{}');
      for (const d in raw) {
        const r = raw[d];
        rows.push([
          d, 
          r.status || '', 
          r.timeOn || '', 
          r.timeOff || '', 
          r.duration || '', 
          r.shift || '', 
          r.taTravelMode || '',
          r.taOnwardTrainNo || '',
          r.taReturnTrainNo || '',
          r.taFrom || '', 
          r.taTo || '', 
          r.taDepartureTime || '', 
          r.taArrivalTime || '', 
          r.taReturnDepartureTime || '', 
          r.taReturnArrivalTime || '', 
          r.taObject || '', 
          (r.notes || '').replace(/\n/g, ' ')
        ]);
      }
      if (rows.length === 1) {
        alert('No data to export for this month.');
        return;
      }
      const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${key}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    exportPdfBtn.addEventListener('click', () => {
      alert('PDF export would be implemented here');
    });

    printBtn.addEventListener('click', () => {
      window.print();
    });

    /* Theme toggles & persistence */
    function setTheme(t) {
      document.body.setAttribute('data-theme', t);
      localStorage.setItem('theme_pref', t);
      themeToggle.textContent = t === 'dark' ? 'Light' : 'Dark';

      // Update theme chip active states
      if (t === 'light') {
        themeLight.classList.add('active');
        themeDark.classList.remove('active');
      } else {
        themeLight.classList.remove('active');
        themeDark.classList.add('active');
      }
    }

    themeToggle.addEventListener('click', () => {
      const cur = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      setTheme(cur);
    });

    themeLight.addEventListener('click', () => setTheme('light'));
    themeDark.addEventListener('click', () => setTheme('dark'));

    /* Shift preset auto fill */
    shiftPreset.addEventListener('change', () => {
      const v = shiftPreset.value;
      if (v === 'morning') {
        shiftSelect.value = 'morning';
      } else if (v === 'evening') {
        shiftSelect.value = 'evening';
      } else if (v === 'night') {
        shiftSelect.value = 'night';
      }
    });

    /* Summary and charts */
    function updateSummary() {
      let p = 0, a = 0, l = 0, r = 0, dd = 0, th = 0, ta = 0, daysCount = 0;
      for (const k in state.data) {
        const e = state.data[k];
        if (!e) continue;
        if (e.status === 'present') p++;
        if (e.status === 'absent') a++;
        if (e.status === 'leave') l++;
        if (e.status === 'rest') r++;
        if (e.timeOn || e.timeOff) dd++;
        if (e.duration) {
          const parts = e.duration.match(/(\d+)h\s*(\d+)m/);
          if (parts) {
            th += parseInt(parts[1]) * 60 + parseInt(parts[2]);
          }
        }
        if (e.taFrom || e.taTo) ta++;
      }
      const daysInMonth = new Date(state.year, state.month, 0).getDate();
      daysCount = daysInMonth;
      sumPresent.textContent = p;
      sumAbsent.textContent = a;
      sumLeave.textContent = l;
      sumRest.textContent = r;
      sumDutyDays.textContent = dd;
      sumTa.textContent = ta;
      statDays.textContent = daysCount;
      statHours.textContent = `${Math.floor(th / 60)}h ${th % 60}m`;
      statPresent.textContent = p;
      statLeave.textContent = l;
      statRest.textContent = r;
      sumHours.textContent = `${Math.floor(th / 60)}h ${th % 60}m`;
    }

    // Add function to update header with pay rate
    function updateHeaderPayRate() {
      const profile = JSON.parse(localStorage.getItem('ta_profile')) || {};
      const payRate = profile.payRate || '';
      const headerPayRateEl = document.getElementById('headerPayRate');
      
      if (payRate) {
        headerPayRateEl.textContent = `Pay Rate: ₹${payRate}`;
      } else {
        headerPayRateEl.textContent = 'Setup Profile';
      }
    }

    /* Init */
    function loadStateFromPicker() {
      const val = monthPicker.value;
      if (!val) return;
      const [y, m] = val.split('-').map(Number);
      state.year = y;
      state.month = m;
      loadMonthData();
      renderCalendar();
    }

    monthPicker.addEventListener('change', loadStateFromPicker);

    (function init() {
      const now = new Date();
      const ym = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      monthPicker.value = ym;
      loadStateFromPicker();
      // theme
      const tp = localStorage.getItem('theme_pref') || 'light';
      setTheme(tp);
      
      // Update header with pay rate
      updateHeaderPayRate();
    })();

    /* Close modal on backdrop click */
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    /* Ensure saveMonthData called when page unloads */
    window.addEventListener('beforeunload', () => saveMonthData());

    // Profile Setup JavaScript
    setupProfileBtn.addEventListener('click', openProfileModal);
    closeProfileModalBtn.addEventListener('click', closeProfileModal);
    saveProfileBtn.addEventListener('click', saveProfile);

    function openProfileModal() {
      loadProfileData();
      profileModal.style.display = 'flex';
    }

    function closeProfileModal() {
      profileModal.style.display = 'none';
    }

    function loadProfileData() {
      const profile = JSON.parse(localStorage.getItem('ta_profile')) || {};
      
      document.getElementById('profileEmployeeName').value = profile.employeeName || '';
      document.getElementById('profileFatherName').value = profile.fatherName || '';
      document.getElementById('profileDesignation').value = profile.designation || '';
      document.getElementById('profileDepartment').value = profile.department || '';
      document.getElementById('profileHeadQuarter').value = profile.headQuarter || '';
      document.getElementById('profileEmpNo').value = profile.empNo || '';
      document.getElementById('profilePayRate').value = profile.payRate || '';
      document.getElementById('profileTaRate').value = profile.taRate || '';
      document.getElementById('profileDOA').value = profile.doa || '';
    }

    function saveProfile() {
      const profile = {
        employeeName: document.getElementById('profileEmployeeName').value,
        fatherName: document.getElementById('profileFatherName').value,
        designation: document.getElementById('profileDesignation').value,
        department: document.getElementById('profileDepartment').value,
        headQuarter: document.getElementById('profileHeadQuarter').value,
        empNo: document.getElementById('profileEmpNo').value,
        payRate: document.getElementById('profilePayRate').value,
        taRate: document.getElementById('profileTaRate').value,
        doa: document.getElementById('profileDOA').value
      };
      
      localStorage.setItem('ta_profile', JSON.stringify(profile));
      alert('Profile saved successfully!');
      closeProfileModal();
      updateHeaderPayRate();
    }

    // TA Form JavaScript
    let taFormData = {
      header: {},
      rows: []
    };

    // Open TA Form
    openTaFormBtn.addEventListener('click', () => {
      // Check if profile is set
      const profile = JSON.parse(localStorage.getItem('ta_profile')) || {};
      if (!profile.employeeName) {
        alert('Please setup your profile first using the "Setup Profile" button.');
        return;
      }
      
      loadTaFormData();
      autoFillTaForm();
      openTaModal();
    });

    // Close TA Form
    closeTaModalBtn.addEventListener('click', closeTaModal);

    // Add Row to TA Table
    addTaRowBtn.addEventListener('click', addTaRow);

    // Print TA Form
    printTaFormBtn.addEventListener('click', printTaForm);

    // Save and Download TA Form
    saveTaFormBtn.addEventListener('click', saveTaForm);

    // Auto-fill profile data function
    function autoFillProfileData() {
      const profile = JSON.parse(localStorage.getItem('ta_profile')) || {};
      
      if (profile.employeeName) {
        document.getElementById('taEmployeeName').value = profile.employeeName;
      }
      if (profile.fatherName) {
        document.getElementById('taFatherName').value = profile.fatherName;
      }
      if (profile.designation) {
        document.getElementById('taDesignation').value = profile.designation;
      }
      if (profile.department) {
        document.getElementById('taDepartment').value = profile.department;
      }
      if (profile.headQuarter) {
        document.getElementById('taHeadQuarter').value = profile.headQuarter;
      }
      if (profile.doa) {
        document.getElementById('taDOA').value = profile.doa;
      }
      if (profile.empNo) {
        document.getElementById('taEmpNo').value = profile.empNo;
      }
      if (profile.payRate) {
        document.getElementById('taPayRate').value = profile.payRate;
      }
      
      // Current month auto-fill
      const currentDate = new Date();
      const currentMonth = currentDate.toLocaleString('default', { month: 'long' });
      const currentYear = currentDate.getFullYear();
      document.getElementById('taMonth').value = `${currentMonth} ${currentYear}`;
    }

    // Calculate percentage based on duty hours
    function calculatePercentage(duration) {
      if (!duration) return "0%";
      
      const hoursMatch = duration.match(/(\d+)h\s*(\d*)m/);
      if (hoursMatch) {
        const hours = parseInt(hoursMatch[1]);
        const minutes = hoursMatch[2] ? parseInt(hoursMatch[2]) : 0;
        const totalHours = hours + (minutes / 60);
        
        if (totalHours >= 12) {
          return "100%";
        } else if (totalHours >= 8) {
          return "70%";
        } else if (totalHours > 0) {
          return "30%";
        }
      }
      return "0%";
    }

    // TA Summary Update Function
    function updateTaSummary() {
      let count30 = 0;
      let count70 = 0;
      let count100 = 0;
      let totalAmount = 0;

      const rows = taTableBody.querySelectorAll('tr');
      rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const percentage = inputs[13].value;
        const amount = parseFloat(inputs[14].value) || 0;

        if (percentage === '30%') count30++;
        else if (percentage === '70%') count70++;
        else if (percentage === '100%') count100++;

        totalAmount += amount;
      });

      document.getElementById('count30').textContent = count30;
      document.getElementById('count70').textContent = count70;
      document.getElementById('count100').textContent = count100;
      document.getElementById('totalAmount').textContent = `₹${totalAmount.toLocaleString()}`;
    }

    function setupTaTableListeners() {
      taTableBody.addEventListener('input', function(e) {
        const target = e.target;
        if (target.classList.contains('ta-percentage') || target.classList.contains('ta-amount')) {
          updateTaSummary();
        }
        
        if (target.classList.contains('ta-percentage')) {
          autoCalculateAmount(target);
        }
      });
    }

    function autoCalculateAmount(percentageInput) {
      const row = percentageInput.closest('tr');
      const inputs = row.querySelectorAll('input');
      const percentage = percentageInput.value;
      const rate = parseFloat(inputs[12].value) || 0;
      
      if (rate > 0 && percentage) {
        const percentValue = parseFloat(percentage) || 0;
        const amount = (rate * percentValue) / 100;
        inputs[14].value = Math.round(amount);
      }
    }

    function saveTaFooterData() {
      const footerData = {
        controllingOfficer: document.getElementById('taControllingOfficer').value,
        headOffice: document.getElementById('taHeadOffice').value,
        signature: document.getElementById('taSignature').value
      };
      localStorage.setItem('ta_footer_data', JSON.stringify(footerData));
    }

    function loadTaFooterData() {
      const footerData = JSON.parse(localStorage.getItem('ta_footer_data')) || {};
      document.getElementById('taControllingOfficer').value = footerData.controllingOfficer || '';
      document.getElementById('taHeadOffice').value = footerData.headOffice || '';
      document.getElementById('taSignature').value = footerData.signature || '';
    }

    function autoFillTaForm() {
      autoFillProfileData();
      
      taTableBody.innerHTML = '';
      
      const taEntries = [];
      for (const date in state.data) {
        const entry = state.data[date];
        if (entry && (entry.taFrom || entry.taTo)) {
          taEntries.push({
            date: date.split('-').reverse().join('/'),
            taTravelMode: entry.taTravelMode,
            taOnwardTrainNo: entry.taOnwardTrainNo,
            taReturnTrainNo: entry.taReturnTrainNo,
            taFrom: entry.taFrom,
            taTo: entry.taTo,
            taDepartureTime: entry.taDepartureTime,
            taArrivalTime: entry.taArrivalTime,
            taReturnDepartureTime: entry.taReturnDepartureTime,
            taReturnArrivalTime: entry.taReturnArrivalTime,
            taObject: entry.taObject,
            timeOn: entry.timeOn,
            timeOff: entry.timeOff,
            duration: entry.duration,
            notes: entry.notes
          });
        }
      }
      
      const profile = JSON.parse(localStorage.getItem('ta_profile')) || {};
      
      taEntries.forEach((entry, index) => {
        addTaRow();
        
        const rows = taTableBody.querySelectorAll('tr');
        const currentRow = rows[rows.length - 1];
        const inputs = currentRow.querySelectorAll('input');
        
        // Both date columns will show the same date for clarity
        inputs[0].value = entry.date; // From HQ to Dist
        inputs[1].value = entry.date; // Dist to HQ
        
        // Train numbers
        if (entry.taTravelMode === 'train') {
          inputs[2].value = entry.taOnwardTrainNo || '';
          inputs[3].value = entry.taReturnTrainNo || '';
        } else {
          inputs[2].value = 'By Road';
          inputs[3].value = 'By Road';
        }
        
        inputs[4].value = entry.taDepartureTime || '';
        inputs[5].value = entry.taArrivalTime || '';
        inputs[6].value = entry.taFrom || '';
        inputs[7].value = entry.taTo || '';
        inputs[8].value = entry.taReturnDepartureTime || '';
        inputs[9].value = entry.taReturnArrivalTime || '';
        inputs[10].value = entry.taObject || entry.notes || 'Official Duty';
        inputs[11].value = entry.duration || '';
        
        const percentage = calculatePercentage(entry.duration);
        inputs[13].value = percentage;
        
        const taRate = profile.taRate || '';
        if (taRate && percentage !== "0%") {
          inputs[12].value = taRate;
          
          const rateValue = parseFloat(taRate.replace(/,/g, '')) || 0;
          const percentValue = parseFloat(percentage) || 0;
          const amount = (rateValue * percentValue) / 100;
          inputs[14].value = Math.round(amount);
        }
      });
      
      if (taEntries.length === 0) {
        addTaRow();
      }
      
      updateTaSummary();
    }

    function openTaModal() {
      taModal.style.display = 'flex';
      setupTaTableListeners();
      updateTaSummary();
      loadTaFooterData();
    }

    function closeTaModal() {
      taModal.style.display = 'none';
    }

    function addTaRow() {
      const rowCount = taTableBody.children.length;
      const row = document.createElement('tr');
      
      row.innerHTML = `
        <td style="border: 1px solid #000; padding: 4px;" class="date-column">
          <input type="text" class="ta-date-onward" placeholder="DD/MM/YY" style="width: 100%; border: none; padding: 3px; font-size: 10px; font-weight: 600; color: #1e40af;">
        </td>
        <td style="border: 1px solid #000; padding: 4px;" class="date-column">
          <input type="text" class="ta-date-return" placeholder="DD/MM/YY" style="width: 100%; border: none; padding: 3px; font-size: 10px; font-weight: 600; color: #1e40af;">
        </td>
        <td style="border: 1px solid #000; padding: 4px;">
          <input type="text" class="ta-onward-train" placeholder="Onward Train No" style="width: 100%; border: none; padding: 3px; font-size: 9px;">
        </td>
        <td style="border: 1px solid #000; padding: 4px;">
          <input type="text" class="ta-return-train" placeholder="Return Train No" style="width: 100%; border: none; padding: 3px; font-size: 9px;">
        </td>
        <td style="border: 1px solid #000; padding: 4px;">
          <input type="text" class="ta-departure-time" placeholder="HH:MM" style="width: 100%; border: none; padding: 3px; font-size: 9px;">
        </td>
        <td style="border: 1px solid #000; padding: 4px;">
          <input type="text" class="ta-arrival-time" placeholder="HH:MM" style="width: 100%; border: none; padding: 3px; font-size: 9px;">
        </td>
        <td style="border: 1px solid #000; padding: 4px;">
          <input type="text" class="ta-station-from" placeholder="Station From" style="width: 100%; border: none; padding: 3px; font-size: 9px;">
        </td>
        <td style="border: 1px solid #000; padding: 4px;">
          <input type="text" class="ta-station-to" placeholder="Station To" style="width: 100%; border: none; padding: 3px; font-size: 9px;">
        </td>
        <td style="border: 1px solid #000; padding: 4px;">
          <input type="text" class="ta-return-departure" placeholder="HH:MM" style="width: 100%; border: none; padding: 3px; font-size: 9px;">
        </td>
        <td style="border: 1px solid #000; padding: 4px;">
          <input type="text" class="ta-return-arrival" placeholder="HH:MM" style="width: 100%; border: none; padding: 3px; font-size: 9px;">
        </td>
        <td style="border: 1px solid #000; padding: 4px;">
          <input type="text" class="ta-journey-object" placeholder="Object of journey" style="width: 100%; border: none; padding: 3px; font-size: 9px;">
        </td>
        <td style="border: 1px solid #000; padding: 4px;">
          <input type="text" class="ta-date-hours" placeholder="08:14" style="width: 100%; border: none; padding: 3px; font-size: 9px;">
        </td>
        <td style="border: 1px solid #000; padding: 4px;">
          <input type="text" class="ta-rate" placeholder="635" style="width: 100%; border: none; padding: 3px; font-size: 9px;">
        </td>
        <td style="border: 1px solid #000; padding: 4px;">
          <input type="text" class="ta-percentage" placeholder="20%" style="width: 100%; border: none; padding: 3px; font-size: 9px;">
        </td>
        <td style="border: 1px solid #000; padding: 4px;">
          <input type="text" class="ta-amount" placeholder="433" style="width: 100%; border: none; padding: 3px; font-size: 9px;">
        </td>
      `;
      
      taTableBody.appendChild(row);
    }

    function loadTaFormData() {
      const saved = localStorage.getItem('ta_form_data');
      if (saved) {
        taFormData = JSON.parse(saved);
        
        if (taFormData.header) {
          document.getElementById('taDepartment').value = taFormData.header.department || '';
          document.getElementById('taHeadQuarter').value = taFormData.header.headQuarter || '';
          document.getElementById('taEmployeeName').value = taFormData.header.employeeName || '';
          document.getElementById('taFatherName').value = taFormData.header.fatherName || '';
          document.getElementById('taDesignation').value = taFormData.header.designation || '';
          document.getElementById('taMonth').value = taFormData.header.month || '';
          document.getElementById('taPayRate').value = taFormData.header.payRate || '';
          document.getElementById('taEmpNo').value = taFormData.header.empNo || '';
          document.getElementById('taDOA').value = taFormData.header.doa || '';
          document.getElementById('taNotes').value = taFormData.header.notes || '';
        }
        
        taTableBody.innerHTML = '';
        if (taFormData.rows && taFormData.rows.length > 0) {
          taFormData.rows.forEach(rowData => {
            addTaRow();
            const lastRow = taTableBody.lastElementChild;
            const inputs = lastRow.querySelectorAll('input');
            
            inputs[0].value = rowData.onwardDate || '';
            inputs[1].value = rowData.returnDate || '';
            inputs[2].value = rowData.onwardTrain || '';
            inputs[3].value = rowData.returnTrain || '';
            inputs[4].value = rowData.departureTime || '';
            inputs[5].value = rowData.arrivalTime || '';
            inputs[6].value = rowData.stationFrom || '';
            inputs[7].value = rowData.stationTo || '';
            inputs[8].value = rowData.returnDeparture || '';
            inputs[9].value = rowData.returnArrival || '';
            inputs[10].value = rowData.journeyObject || '';
            inputs[11].value = rowData.dateHours || '';
            inputs[12].value = rowData.rate || '';
            inputs[13].value = rowData.percentage || '';
            inputs[14].value = rowData.amount || '';
          });
        }
      } else {
        addTaRow();
      }
    }

    function saveTaFormData() {
      taFormData.header = {
        department: document.getElementById('taDepartment').value,
        headQuarter: document.getElementById('taHeadQuarter').value,
        employeeName: document.getElementById('taEmployeeName').value,
        fatherName: document.getElementById('taFatherName').value,
        designation: document.getElementById('taDesignation').value,
        month: document.getElementById('taMonth').value,
        payRate: document.getElementById('taPayRate').value,
        empNo: document.getElementById('taEmpNo').value,
        doa: document.getElementById('taDOA').value,
        notes: document.getElementById('taNotes').value
      };
      
      taFormData.rows = [];
      const rows = taTableBody.querySelectorAll('tr');
      
      rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        taFormData.rows.push({
          onwardDate: inputs[0].value,
          returnDate: inputs[1].value,
          onwardTrain: inputs[2].value,
          returnTrain: inputs[3].value,
          departureTime: inputs[4].value,
          arrivalTime: inputs[5].value,
          stationFrom: inputs[6].value,
          stationTo: inputs[7].value,
          returnDeparture: inputs[8].value,
          returnArrival: inputs[9].value,
          journeyObject: inputs[10].value,
          dateHours: inputs[11].value,
          rate: inputs[12].value,
          percentage: inputs[13].value,
          amount: inputs[14].value
        });
      });
      
      localStorage.setItem('ta_form_data', JSON.stringify(taFormData));
    }

    function printTaForm() {
      saveTaFormData();
      saveTaFooterData();
      
      const footerData = JSON.parse(localStorage.getItem('ta_footer_data')) || {};

      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Northern Railway - TA Form</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; }
              .ta-form-header { border: 2px solid #000; padding: 15px; margin-bottom: 15px; }
              table { width: 100%; border-collapse: collapse; font-size: 10px; table-layout: fixed; }
              th, td { border: 1px solid #000; padding: 3px; text-align: left; overflow: hidden; text-overflow: ellipsis; }
              th { background: #f0f0f0; }
              .text-center { text-align: center; }
              .notes { margin-top: 15px; padding: 10px; border: 1px solid #ccc; }
              .summary { margin: 15px 0; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; }
              .footer { margin-top: 15px; padding: 15px; border: 1px solid #ccc; background: #f9f9f9; }
              .footer-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 10px; }
              .header-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; font-size: 12px; }
              .header-item { display: flex; margin-bottom: 5px; }
              .header-item label { font-weight: bold; min-width: 120px; }
            </style>
          </head>
          <body>
            <div class="ta-form-header">
              <div class="text-center">
                <h3>NORTHERN RAILWAY</h3>
                <div style="margin-top: 5px;">
                  <span>Travelling Allowance Journal</span>
                </div>
              </div>
              <div class="header-grid">
                <div>
                  <div class="header-item"><label>Department:</label> ${taFormData.header.department || ''}</div>
                  <div class="header-item"><label>Head Quarter:</label> ${taFormData.header.headQuarter || ''}</div>
                  <div class="header-item"><label>Employee Name:</label> ${taFormData.header.employeeName || ''}</div>
                  <div class="header-item"><label>Father's Name:</label> ${taFormData.header.fatherName || ''}</div>
                  <div class="header-item"><label>Designation:</label> ${taFormData.header.designation || ''}</div>
                </div>
                <div>
                  <div class="header-item"><label>Month:</label> ${taFormData.header.month || ''}</div>
                  <div class="header-item"><label>Pay Rate (Rs.):</label> ${taFormData.header.payRate || ''}</div>
                  <div class="header-item"><label>Emp No:</label> ${taFormData.header.empNo || ''}</div>
                  <div class="header-item"><label>D.O.A:</label> ${taFormData.header.doa || ''}</div>
                </div>
              </div>
            </div>
            
            <table>
              <thead>
                <tr>
                  <th style="width: 10%;">Date (From HQ to Dist)</th>
                  <th style="width: 10%;">Date (Dist to HQ)</th>
                  <th style="width: 7%;">Onward Train No.</th>
                  <th style="width: 7%;">Return Train No.</th>
                  <th style="width: 6%;">Departure Time (HQ)</th>
                  <th style="width: 6%;">Arrival Time (Dest)</th>
                  <th style="width: 6%;">From</th>
                  <th style="width: 6%;">To</th>
                  <th style="width: 6%;">Return Dept</th>
                  <th style="width: 6%;">Return Arr (HQ)</th>
                  <th style="width: 18%;">Object of journey</th>
                  <th style="width: 5%;">Hours</th>
                  <th style="width: 5%;">Rate</th>
                  <th style="width: 5%;">%</th>
                  <th style="width: 7%;">Amount Rs.</th>
                </tr>
              </thead>
              <tbody>
                ${taFormData.rows.map(row => `
                  <tr>
                    <td>${row.onwardDate || ''}</td>
                    <td>${row.returnDate || ''}</td>
                    <td>${row.onwardTrain || ''}</td>
                    <td>${row.returnTrain || ''}</td>
                    <td>${row.departureTime || ''}</td>
                    <td>${row.arrivalTime || ''}</td>
                    <td>${row.stationFrom || ''}</td>
                    <td>${row.stationTo || ''}</td>
                    <td>${row.returnDeparture || ''}</td>
                    <td>${row.returnArrival || ''}</td>
                    <td>${row.journeyObject || ''}</td>
                    <td>${row.dateHours || ''}</td>
                    <td>${row.rate || ''}</td>
                    <td>${row.percentage || ''}</td>
                    <td>${row.amount || ''}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            
            <!-- Summary Section -->
            <div class="summary">
              <div style="font-weight: bold; margin-bottom: 8px;">Percentage Summary</div>
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; text-align: center;">
                <div>
                  <div style="font-size: 12px; color: #666;">30% Count</div>
                  <div style="font-weight: bold; font-size: 16px;">${document.getElementById('count30').textContent}</div>
                </div>
                <div>
                  <div style="font-size: 12px; color: #666;">70% Count</div>
                  <div style="font-weight: bold; font-size: 16px;">${document.getElementById('count70').textContent}</div>
                </div>
                <div>
                  <div style="font-size: 12px; color: #666;">100% Count</div>
                  <div style="font-weight: bold; font-size: 16px;">${document.getElementById('count100').textContent}</div>
                </div>
                <div>
                  <div style="font-size: 12px; color: #666;">Total Amount</div>
                  <div style="font-weight: bold; font-size: 16px; color: #4f46e5;">${document.getElementById('totalAmount').textContent}</div>
                </div>
              </div>
            </div>
            
            ${taFormData.header.notes ? `
            <div class="notes">
              <strong>NOTE BOOK</strong>
              <div>${taFormData.header.notes}</div>
            </div>
            ` : ''}
            
            <!-- Footer Section -->
            <div class="footer">
              <div style="font-weight: bold; margin-bottom: 10px;">Approval & Signature</div>
              <div class="footer-grid">
                <div>
                  <div style="font-size: 12px; color: #666;">Controlling Officer</div>
                  <div style="margin-top: 5px; border-bottom: 1px solid #000; padding-bottom: 5px; min-height: 20px;">
                    ${footerData.controllingOfficer || ''}
                  </div>
                </div>
                <div>
                  <div style="font-size: 12px; color: #666;">Head Office</div>
                  <div style="margin-top: 5px; border-bottom: 1px solid #000; padding-bottom: 5px; min-height: 20px;">
                    ${footerData.headOffice || ''}
                  </div>
                </div>
                <div>
                  <div style="font-size: 12px; color: #666;">Signature</div>
                  <div style="margin-top: 5px; border-bottom: 1px solid #000; padding-bottom: 5px; min-height: 20px;">
                    ${footerData.signature || ''}
                  </div>
                </div>
              </div>
            </div>
            
            <script>
              window.onload = function() {
                window.print();
              };
            <\/script>
          </body>
        </html>
      `);
      printWindow.document.close();
    }

    function saveTaForm() {
      saveTaFormData();
      saveTaFooterData();
      
      const footerData = JSON.parse(localStorage.getItem('ta_footer_data')) || {};

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const margin = 15;
      
      pdf.setFontSize(16);
      pdf.setTextColor(0, 0, 0);
      pdf.text('NORTHERN RAILWAY', pageWidth/2, margin, {align: 'center'});
      
      pdf.setFontSize(12);
      pdf.text('Travelling Allowance Journal', pageWidth/2, margin + 10, {align: 'center'});
      
      let yPos = margin + 20;
      pdf.setFontSize(10);
      
      // Header information in two columns
      const leftCol = margin;
      const rightCol = pageWidth/2 + 10;
      
      pdf.text(`Department: ${taFormData.header.department || ''}`, leftCol, yPos);
      pdf.text(`Head Quarter: ${taFormData.header.headQuarter || ''}`, rightCol, yPos);
      yPos += 6;
      
      pdf.text(`Employee Name: ${taFormData.header.employeeName || ''}`, leftCol, yPos);
      pdf.text(`Father's Name: ${taFormData.header.fatherName || ''}`, rightCol, yPos);
      yPos += 6;
      
      pdf.text(`Designation: ${taFormData.header.designation || ''}`, leftCol, yPos);
      pdf.text(`Month: ${taFormData.header.month || ''}`, rightCol, yPos);
      yPos += 6;
      
      pdf.text(`Pay Rate: ${taFormData.header.payRate || ''}`, leftCol, yPos);
      pdf.text(`Emp No: ${taFormData.header.empNo || ''}`, rightCol, yPos);
      yPos += 6;
      
      pdf.text(`D.O.A: ${taFormData.header.doa || ''}`, leftCol, yPos);
      yPos += 15;
      
      const colWidths = [14, 14, 10, 10, 8, 8, 8, 6, 8, 8, 22, 6, 6, 6, 8];
      const headers = ['Date (HQ to Dist)', 'Date (Dist to HQ)', 'Onward', 'Return', 'Dept', 'Arr', 'From', 'To', 'Ret Dept', 'Ret Arr', 'Object', 'Hours', 'Rate', '%', 'Amount'];
      
      let xPos = margin;
      pdf.setFontSize(6);
      headers.forEach((header, i) => {
        pdf.text(header, xPos, yPos);
        xPos += colWidths[i];
      });
      
      yPos += 4;
      pdf.line(margin, yPos, pageWidth - margin, yPos);
      yPos += 6;
      
      pdf.setFontSize(5);
      taFormData.rows.forEach(row => {
        if (yPos > 270) {
          pdf.addPage();
          yPos = margin;
        }
        
        xPos = margin;
        const rowData = [
          row.onwardDate || '',
          row.returnDate || '',
          row.onwardTrain || '',
          row.returnTrain || '',
          row.departureTime || '',
          row.arrivalTime || '',
          row.stationFrom || '',
          row.stationTo || '',
          row.returnDeparture || '',
          row.returnArrival || '',
          row.journeyObject || '',
          row.dateHours || '',
          row.rate || '',
          row.percentage || '',
          row.amount || ''
        ];
        
        rowData.forEach((data, i) => {
          const lines = pdf.splitTextToSize(data, colWidths[i] - 2);
          pdf.text(lines, xPos, yPos);
          xPos += colWidths[i];
        });
        
        yPos += 10;
      });
      
      if (yPos > 250) {
        pdf.addPage();
        yPos = margin;
      }
      
      yPos += 10;
      pdf.setFontSize(10);
      pdf.text('Percentage Summary', margin, yPos);
      yPos += 6;
      
      const count30 = document.getElementById('count30').textContent;
      const count70 = document.getElementById('count70').textContent;
      const count100 = document.getElementById('count100').textContent;
      const totalAmount = document.getElementById('totalAmount').textContent;
      
      pdf.text(`30% Count: ${count30}`, margin, yPos);
      pdf.text(`70% Count: ${count70}`, margin + 40, yPos);
      pdf.text(`100% Count: ${count100}`, margin + 80, yPos);
      pdf.text(`Total Amount: ${totalAmount}`, margin + 120, yPos);
      yPos += 15;
      
      if (taFormData.header.notes) {
        if (yPos > 250) {
          pdf.addPage();
          yPos = margin;
        }
        
        yPos += 10;
        pdf.setFontSize(10);
        pdf.text('NOTE BOOK', margin, yPos);
        yPos += 6;
        pdf.setFontSize(8);
        const noteLines = pdf.splitTextToSize(taFormData.header.notes, pageWidth - 2*margin);
        pdf.text(noteLines, margin, yPos);
        yPos += noteLines.length * 4 + 10;
      }
      
      if (yPos > 220) {
        pdf.addPage();
        yPos = margin;
      }
      
      yPos += 10;
      pdf.setFontSize(10);
      pdf.text('Approval & Signature', margin, yPos);
      yPos += 6;
      
      pdf.setFontSize(8);
      pdf.text(`Controlling Officer: ${footerData.controllingOfficer || ''}`, margin, yPos);
      yPos += 5;
      pdf.text(`Head Office: ${footerData.headOffice || ''}`, margin, yPos);
      yPos += 5;
      pdf.text(`Signature: ${footerData.signature || ''}`, margin, yPos);
      
      const fileName = `TA_Form_${new Date().toISOString().split('T')[0]}.pdf`;
      pdf.save(fileName);
      
      alert('TA Form saved and downloaded successfully!');
    }

    // Close TA modal on backdrop click
    taModal.addEventListener('click', (e) => {
      if (e.target === taModal) closeTaModal();
    });

    // Close Profile modal on backdrop click
    profileModal.addEventListener('click', (e) => {
      if (e.target === profileModal) closeProfileModal();
    });
  </script>
</body>
</html>